name: Auto Tag (Semver) on Push

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  WINTUN_VERSION: "0.14.1"
  WINTUN_SHA256: "07c256185d6ee3652e09fa55c0b673e2624b565e02c4b9091c79ca7d2f24ef51"

permissions:
  contents: write

concurrency:
  group: semver-tag
  cancel-in-progress: false

jobs:
  tag:
    name: Create and push version tag
    # Avoid any future recursion if we ever add a bot-commit step.
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute next version tag
        id: semver
        shell: bash
        run: |
          set -euo pipefail

          msg="$(git log -1 --pretty=%B)"
          echo "Commit message:"$'\n'"$msg"$'\n'

          bump="patch"
          if echo "$msg" | grep -qiE 'BREAKING CHANGE|(^|\n).*!:|(^|\n)feat!'; then
            bump="major"
          elif echo "$msg" | grep -qiE '(^|\n)feat(\(.+\))?:'; then
            bump="minor"
          elif echo "$msg" | grep -qiE '(^|\n)fix(\(.+\))?:'; then
            bump="patch"
          fi
          echo "Bump: $bump"

          latest_tag="$(git tag -l 'v*' --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n1 || true)"
          if [ -z "$latest_tag" ]; then
            cargo_ver="$(awk '
              /^\[workspace\.package\]/ { in_section=1; next }
              /^\[/ { in_section=0 }
              in_section && /^version[[:space:]]*=/ {
                gsub(/"/, "", $3);
                print $3;
                exit
              }
            ' Cargo.toml)"
            if [ -z "$cargo_ver" ]; then
              echo "::error::Could not find a previous vX.Y.Z tag and could not read [workspace.package].version from Cargo.toml"
              exit 1
            fi
            latest_tag="v$cargo_ver"
          fi

          base="${latest_tag#v}"
          IFS='.' read -r major minor patch <<< "$base"

          case "$bump" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac

          next="v${major}.${minor}.${patch}"

          # Ensure uniqueness in case of races or manual tags.
          while git rev-parse -q --verify "refs/tags/$next" >/dev/null; do
            patch=$((patch + 1))
            next="v${major}.${minor}.${patch}"
          done

          echo "next_tag=$next" >> "$GITHUB_OUTPUT"
          echo "Next tag: $next"

      - name: Create and push tag
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ steps.semver.outputs.next_tag }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "$tag" -m "Release $tag" "${GITHUB_SHA}"
          git push origin "$tag"

          echo "âœ“ Pushed $tag"
