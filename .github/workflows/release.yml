name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  WINTUN_VERSION: "0.14.1"
  WINTUN_SHA256: "07c256185d6ee3652e09fa55c0b673e2624b565e02c4b9091c79ca7d2f24ef51"

permissions:
  contents: write

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    permissions:
      contents: read
    strategy:
      matrix:
        target: [x86_64-pc-windows-msvc]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: Download and prepare Wintun DLL
        shell: pwsh
        run: |
          # Download Wintun
          $wintunVersion = "${{ env.WINTUN_VERSION }}"
          $wintunUrl = "https://www.wintun.net/builds/wintun-$wintunVersion.zip"
          $wintunZip = "wintun.zip"
          $expectedHash = "${{ env.WINTUN_SHA256 }}"

          Write-Host "Downloading Wintun $wintunVersion..."
          Invoke-WebRequest -Uri $wintunUrl -OutFile $wintunZip

          # Verify checksum for security
          Write-Host "Verifying checksum..."
          $actualHash = (Get-FileHash -Path $wintunZip -Algorithm SHA256).Hash.ToLower()
          if ($actualHash -ne $expectedHash) {
            Write-Error "Checksum verification failed! Expected: $expectedHash, Got: $actualHash"
            exit 1
          }
          Write-Host "âœ“ Checksum verified successfully"

          # Extract and organize DLLs
          Write-Host "Extracting Wintun..."
          Expand-Archive -Path $wintunZip -DestinationPath wintun-temp

          # Create resources directory
          New-Item -ItemType Directory -Force -Path resources

          # Copy and rename DLLs for each architecture
          Copy-Item "wintun-temp/wintun/bin/amd64/wintun.dll" "resources/wintun_amd64.dll"
          Copy-Item "wintun-temp/wintun/bin/x86/wintun.dll" "resources/wintun_x86.dll"
          Copy-Item "wintun-temp/wintun/bin/arm64/wintun.dll" "resources/wintun_arm64.dll"
          Copy-Item "wintun-temp/wintun/bin/arm/wintun.dll" "resources/wintun_arm.dll"

          Write-Host "Wintun DLLs prepared in resources directory"
          Get-ChildItem resources

          # Clean up
          Remove-Item -Recurse -Force wintun-temp
          Remove-Item $wintunZip

      - name: Build
        run: cargo build --release --target ${{ matrix.target }} -p bonding-client -p bonding-server --verbose

      - name: Package
        shell: pwsh
        run: |
          $target = "${{ matrix.target }}"

          $packages = @(
            @{ Name = "bonding-client"; Binary = "bonding-client.exe"; Archive = "bonding-client-windows-$target.zip" },
            @{ Name = "bonding-server"; Binary = "bonding-server.exe"; Archive = "bonding-server-windows-$target.zip" }
          )

          foreach ($p in $packages) {
            # Clean and create package directory
            if (Test-Path "package") { Remove-Item -Recurse -Force "package" }
            New-Item -ItemType Directory -Force -Path package | Out-Null

            # Copy binary
            $binPath = "target/$target/release/$($p.Binary)"
            if (-not (Test-Path $binPath)) {
              Write-Error "Expected binary not found: $binPath"
              exit 1
            }
            Copy-Item $binPath package/

            # Copy README and LICENSE files
            if (Test-Path "README.md") { Copy-Item "README.md" package/ }
            if (Test-Path "LICENSE-MIT") { Copy-Item "LICENSE-MIT" package/ }
            if (Test-Path "LICENSE-APACHE") { Copy-Item "LICENSE-APACHE" package/ }

            # Create archive
            if (Test-Path $p.Archive) { Remove-Item -Force $p.Archive }
            Compress-Archive -Path package/* -DestinationPath $p.Archive

            Write-Host "Created archive: $($p.Archive)"
          }

      - name: Upload Release Assets
        uses: actions/upload-artifact@v4
        with:
          name: bonding-windows-${{ matrix.target }}
          path: |
            ./bonding-client-windows-${{ matrix.target }}.zip
            ./bonding-server-windows-${{ matrix.target }}.zip

  build-linux:
    name: Build Linux
    runs-on: ubuntu-22.04
    permissions:
      contents: read
    strategy:
      matrix:
        target: [x86_64-unknown-linux-gnu]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: Build
        run: cargo build --release --target ${{ matrix.target }} -p bonding-client -p bonding-server --verbose

      - name: Package
        run: |
          target="${{ matrix.target }}"

          for bin in bonding-client bonding-server; do
            archive_name="${bin}-linux-${target}.tar.gz"

            rm -rf package
            mkdir -p package

            # Copy binary
            if [ ! -f "target/${target}/release/${bin}" ]; then
              echo "Expected binary not found: target/${target}/release/${bin}" >&2
              exit 1
            fi
            cp "target/${target}/release/${bin}" package/

            # Copy README and LICENSE files
            [ -f README.md ] && cp README.md package/
            [ -f LICENSE-MIT ] && cp LICENSE-MIT package/
            [ -f LICENSE-APACHE ] && cp LICENSE-APACHE package/

            # Create archive
            tar -czf "${archive_name}" -C package .

            echo "Created archive: ${archive_name}"
          done

      - name: Upload Release Assets
        uses: actions/upload-artifact@v4
        with:
          name: bonding-linux-${{ matrix.target }}
          path: |
            ./bonding-client-linux-${{ matrix.target }}.tar.gz
            ./bonding-server-linux-${{ matrix.target }}.tar.gz

  release:
    name: Create Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
